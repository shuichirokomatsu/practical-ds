<!DOCTYPE html>
<html lang="en">
  

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,minimum-scale=1">

  <title>数値データの取り扱い</title>
  <meta name="description" content="source(here::here("R/setup.R"))">

  <link rel="canonical" href="https://uribo.github.io/practical-ds/02/numeric.html">
  <link rel="alternate" type="application/rss+xml" title="Practical Data Science with R and Python" href="https://uribo.github.io/practical-ds/feed.xml">

  <meta property="og:url"         content="https://uribo.github.io/practical-ds/02/numeric.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="数値データの取り扱い" />
<meta property="og:description" content="source(here::here("R/setup.R"))" />
<meta property="og:image"       content="" />


  <script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "NewsArticle",
  "mainEntityOfPage":
    "https://uribo.github.io/practical-ds/02/numeric.html",
  "headline":
    "数値データの取り扱い",
  "datePublished":
    "2019-07-04T08:12:52+09:00",
  "dateModified":
    "2019-07-04T08:12:52+09:00",
  "description":
    "source(here::here("R/setup.R"))",
  "author": {
    "@type": "Person",
    "name": "Shinya Uryu"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Data 100 at UC Berkeley",
    "logo": {
      "@type": "ImageObject",
      "url": "https://uribo.github.io/practical-ds",
      "width": 60,
      "height": 60
    }
  },
  "image": {
    "@type": "ImageObject",
    "url": "https://uribo.github.io/practical-ds",
    "height": 60,
    "width": 60
  }
}

  </script>
  <link rel="stylesheet" href="/practical-ds/assets/css/styles.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css ">
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">

  <!-- <link rel="manifest" href="/manifest.json"> -->
  <!-- <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#efae0a"> -->
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/mstile-144x144.png">
  <meta name="theme-color" content="#233947">

  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="/practical-ds/images/logo/favicon.ico">

  <!-- MathJax Config -->
  <!-- Allow inline math using $ and automatically break long math lines -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true,
        processEnvironments: true
    },
    CommonHTML: {
        linebreaks: {
            automatic: true,
        },
    },
});
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_CHTML' async></script>

  <!-- DOM updating function -->
  <script>
const runWhenDOMLoaded = cb => {
  if (document.readyState != 'loading') {
    cb()
  } else if (document.addEventListener) {
    document.addEventListener('DOMContentLoaded', cb)
  } else {
    document.attachEvent('onreadystatechange', function() {
      if (document.readyState == 'complete') cb()
    })
  }
}

// Helper function to init things quickly
initFunction = function(myfunc) {
  runWhenDOMLoaded(myfunc);
  document.addEventListener('turbolinks:load', myfunc);
};
</script>

  <!-- Define some javascript variables that will be useful in other javascript -->
  <script>
    const site_basename = '/practical-ds';
  </script>

  <!-- Add AnchorJS to let headers be linked -->
  <script src="/practical-ds/assets/js/anchor.min.js"  type="text/javascript"></script>
  <script>

initFunction(function () {
    anchors.add("main h1, main h2, main h3, main h4")
});

</script>

  <!-- Include Turbolinks to make page loads fast -->
  <!-- https://github.com/turbolinks/turbolinks -->
  <script src="/practical-ds/assets/js/turbolinks.js" async></script>
  <meta name="turbolinks-cache-control" content="no-cache">

  <!-- Load nbinteract for widgets -->
  <script src="https://unpkg.com/nbinteract-core" async></script>

  <!-- Load Thebelab for interactive widgets -->
  <!-- Include Thebelab for interactive code if it's enabled -->


  <!-- Google analytics -->
  <script src="/practical-ds/assets/js/ga.js" async></script>

  <!-- Clipboard copy button -->
  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" async></script>

  <!-- Load JS that depends on site variables -->
  <script>
/**
 * Set up copy/paste for code blocks
 */
const codeCellId = index => `codecell${index}`

const clipboardButton = id =>
  `<a class="btn copybtn o-tooltip--left" data-tooltip="Copy" data-clipboard-target="#${id}">
    <img src="/practical-ds/assets/images/copy-button.svg" alt="Copy to clipboard">
  </a>`

// Clears selected text since ClipboardJS will select the text when copying
const clearSelection = () => {
  if (window.getSelection) {
    window.getSelection().removeAllRanges()
  } else if (document.selection) {
    document.selection.empty()
  }
}

// Changes tooltip text for two seconds, then changes it back
const temporarilyChangeTooltip = (el, newText) => {
  const oldText = el.getAttribute('data-tooltip')
  el.setAttribute('data-tooltip', newText)
  setTimeout(() => el.setAttribute('data-tooltip', oldText), 2000)
}

const addCopyButtonToCodeCells = () => {
  // If ClipboardJS hasn't loaded, wait a bit and try again. This
  // happens because we load ClipboardJS asynchronously.
  if (window.ClipboardJS === undefined) {
    setTimeout(addCopyButtonToCodeCells, 250)
    return
  }

  const codeCells = document.querySelectorAll('div.highlighter-rouge:not(.output) pre')
  codeCells.forEach((codeCell, index) => {
    const id = codeCellId(index)
    codeCell.setAttribute('id', id)
    if (document.querySelector(`pre#${id} + a`) == null) {
      codeCell.insertAdjacentHTML('afterend', clipboardButton(id));
    }
  })

  const clipboard = new ClipboardJS('.copybtn')
  clipboard.on('success', event => {
    clearSelection()
    temporarilyChangeTooltip(event.trigger, 'Copied!')
  })

  clipboard.on('error', event => {
    temporarilyChangeTooltip(event.trigger, 'Failed to copy')
  })

  // Get rid of clipboard before the next page visit to avoid memory leak
  document.addEventListener('turbolinks:before-visit', () =>
    clipboard.destroy()
  )
}

initFunction(addCopyButtonToCodeCells);
</script>

  <!-- Hide cell code -->
  
<script>
/**
Add buttons to hide code cells
*/


var setCodeCellVisibility = function(inputField, kind) {
    // Update the image and class for hidden
    var id = inputField.getAttribute('data-id');
    var codeCell = document.querySelector(`#${id}`);

    if (kind === "visible") {
        codeCell.classList.remove('hidden');
        inputField.checked = true;
    } else {
        codeCell.classList.add('hidden');
        inputField.checked = false;
    }
}

var toggleCodeCellVisibility = function (event) {
    // The label is clicked, and now we decide what to do based on the input field's clicked status
    if (event.target.tagName === "LABEL") {
        var inputField = event.target.previousElementSibling;
    } else {
        // It is the span inside the target
        var inputField = event.target.parentElement.previousElementSibling;
    }

    if (inputField.checked === true) {
        setCodeCellVisibility(inputField, "visible");
    } else {
        setCodeCellVisibility(inputField, "hidden");
    }
}


// Button constructor
const hideCodeButton = id => `<input class="hidebtn" type="checkbox" id="hidebtn${id}" data-id="${id}"><label title="Toggle cell" for="hidebtn${id}" class="plusminus"><span class="pm_h"></span><span class="pm_v"></span></label>`

var addHideButton = function () {
  // If a hide button is already added, don't add another
  if (document.querySelector('div.hidecode input') !== null) {
      return;
  }

  // Find the input cells and add a hide button
  document.querySelectorAll('div.input_area div.highlight').forEach(function (item, index) {
    if (!item.parentElement.classList.contains("hidecode")) {
        // Skip the cell if it doesn't have a hidecode class
        return;
    }

    const id = codeCellId(index)
    item.setAttribute('id', id);
    item.insertAdjacentHTML('afterend', hideCodeButton(id))

    // Set up the visibility toggle
    hideLink = document.querySelector(`#${id} + input + label`);
    hideLink.addEventListener('click', toggleCodeCellVisibility)
  });
}


// Initialize the hide buttos
var initHiddenCells = function () {
    // Add hide buttons to the cells
    addHideButton();

    // Toggle the code cells that should be hidden
    document.querySelectorAll('div.hidecode input').forEach(function (item) {
        setCodeCellVisibility(item, 'hidden');
        item.checked = true;
    })
}

initFunction(initHiddenCells);

</script>


  <!-- Load custom website scripts -->
  <script src="/practical-ds/assets/js/scripts.js" async></script>

  <!-- Load custom user CSS and JS  -->
  <script src="/practical-ds/assets/custom/custom.js" async></script>
  <link rel="stylesheet" href="/practical-ds/assets/custom/custom.css">

  <!-- Update interact links w/ REST param, is defined in includes so we can use templates -->
  

  <!-- Lunr search code - will only be executed on the /search page -->
  <script src="/practical-ds/assets/js/lunr/lunr.min.js" type="text/javascript"></script>
  <script>var initQuery = function() {
  // See if we have a search box
  var searchInput = document.querySelector('input#lunr_search');
  if (searchInput === null) {
    return;
  }

  // Function to parse our lunr cache
  var idx = lunr(function () {
    this.field('title')
    this.field('excerpt')
    this.field('categories')
    this.field('tags')
    this.ref('id')

    this.pipeline.remove(lunr.trimmer)

    for (var item in store) {
      this.add({
        title: store[item].title,
        excerpt: store[item].excerpt,
        categories: store[item].categories,
        tags: store[item].tags,
        id: item
      })
    }
  });

  // Run search upon keyup
  searchInput.addEventListener('keyup', function () {
    var resultdiv = document.querySelector('#results');
    var query = document.querySelector("input#lunr_search").value.toLowerCase();
    var result =
      idx.query(function (q) {
        query.split(lunr.tokenizer.separator).forEach(function (term) {
          q.term(term, { boost: 100 })
          if(query.lastIndexOf(" ") != query.length-1){
            q.term(term, {  usePipeline: false, wildcard: lunr.Query.wildcard.TRAILING, boost: 10 })
          }
          if (term != ""){
            q.term(term, {  usePipeline: false, editDistance: 1, boost: 1 })
          }
        })
      });

      // Empty the results div
      while (resultdiv.firstChild) {
        resultdiv.removeChild(resultdiv.firstChild);
      }

    resultdiv.insertAdjacentHTML('afterbegin', '<p class="results__found">'+result.length+' Result(s) found</p>');
    for (var item in result) {
      var ref = result[item].ref;
      if(store[ref].teaser){
        var searchitem =
          '<div class="list__item">'+
            '<article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">'+
              '<h2 class="archive__item-title" itemprop="headline">'+
                '<a href="'+store[ref].url+'" rel="permalink">'+store[ref].title+'</a>'+
              '</h2>'+
              '<div class="archive__item-teaser">'+
                '<img src="'+store[ref].teaser+'" alt="">'+
              '</div>'+
              '<p class="archive__item-excerpt" itemprop="description">'+store[ref].excerpt.split(" ").splice(0,20).join(" ")+'...</p>'+
            '</article>'+
          '</div>';
      }
      else{
    	  var searchitem =
          '<div class="list__item">'+
            '<article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">'+
              '<h2 class="archive__item-title" itemprop="headline">'+
                '<a href="'+store[ref].url+'" rel="permalink">'+store[ref].title+'</a>'+
              '</h2>'+
              '<p class="archive__item-excerpt" itemprop="description">'+store[ref].excerpt.split(" ").splice(0,20).join(" ")+'...</p>'+
            '</article>'+
          '</div>';
      }
      resultdiv.insertAdjacentHTML('beforeend', searchitem);
    }
  });
};

initFunction(initQuery);
</script>
</head>

  <body>
    <!-- .js-show-sidebar shows sidebar by default -->
    <div id="js-textbook" class="c-textbook js-show-sidebar">
      



<nav id="js-sidebar" class="c-textbook__sidebar">
  <a href="https://jupyter.org/jupyter-book/"><img src="/practical-ds/images/logo/logo.png" class="textbook_logo" id="sidebar-logo" data-turbolinks-permanent/></a>
  <h2 class="c-sidebar__title">Practical Data Science with R and Python</h2>
  <ul class="c-sidebar__chapters">
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/practical-ds/intro.html"
        >
          
          Home
        </a>

        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="https://github.com/uribo/practical-ds"
        >
          
          GitHub repository
        </a>

        
      </li>

      
    
      
      
        <li class="c-sidebar__chapter"><a class="c-sidebar__entry" href="/practical-ds/search.html">Search</a></li>
        
      
      
        <li class="c-sidebar__divider"></li>
        
      
      
        <li><h2 class="c-sidebar__title">Demo textbook</li>
        
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/practical-ds/01/readme.html"
        >
          
          データ分析の流れ
        </a>

        

          
          
          
          

          

          <ul class="c-sidebar__sections ">
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/practical-ds/01/introduction.html"
                >
                  
                  データ分析のプロセス
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/practical-ds/01/eda.html"
                >
                  
                  探索的データ分析
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/practical-ds/01/tidy_data.html"
                >
                  
                  tidyデータと前処理
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/practical-ds/01/tidymodels_workflow.html"
                >
                  
                  モデルの構築から評価まで
                </a>

                
                

              </li>
              
            
          </ul>
        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/practical-ds/02/readme.html"
        >
          
          特徴量エンジニアリング
        </a>

        

          
          
          
          

          

          <ul class="c-sidebar__sections ">
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry c-sidebar__entry--active"
                  href="/practical-ds/02/numeric.html"
                >
                  
                  数値データの取り扱い
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/practical-ds/02/categorical.html"
                >
                  
                  カテゴリデータの取り扱い
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/practical-ds/02/text.html"
                >
                  
                  テキストデータの取り扱い
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/practical-ds/02/date-and-time.html"
                >
                  
                  日付・時間データの取り扱い
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/practical-ds/02/spatial-data.html"
                >
                  
                  地理空間データの取り扱い
                </a>

                
                

              </li>
              
            
          </ul>
        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/practical-ds/03/readme.html"
        >
          
          より良いモデルを目指して
        </a>

        

          
          
          
          

          

          <ul class="c-sidebar__sections ">
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/practical-ds/03/handling-missing-data.html"
                >
                  
                  欠損値の処理
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/practical-ds/03/dimension-reduction.html"
                >
                  
                  次元削減
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/practical-ds/03/model-performance.html"
                >
                  
                  モデルの性能評価
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/practical-ds/03/data-splitting.html"
                >
                  
                  データ分割
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/practical-ds/03/feature-selection.html"
                >
                  
                  変数重要度
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/practical-ds/03/interpretability.html"
                >
                  
                  モデルの解釈
                </a>

                
                

              </li>
              
            
          </ul>
        
      </li>

      
    
  </ul>
  <p class="sidebar_footer">Powered by <a href="https://github.com/jupyter/jupyter-book">Jupyter Book</a></p>
</nav>

      
      <!-- Shamelessly copied from minimal mistakes -->


<!-- TOC will only show up if it has at least one item -->


  <aside class="sidebar__right">
    <nav class="onthispage">
      <header><h4 class="nav__title"><i class="fa fa-list"></i>   On this page</h4></header>
      <ul class="toc__menu">
  <li><a href="#数値データが抱える問題">数値データが抱える問題</a></li>
  <li><a href="#対数変換">対数変換</a></li>
  <li><a href="#rank-transformation">rank transformation</a></li>
  <li><a href="#対数変換-1">対数変換</a>
    <ul>
      <li><a href="#box-cox変換">Box-Cox変換</a></li>
    </ul>
  </li>
  <li><a href="#ロジット変換">ロジット変換</a></li>
  <li><a href="#binning">Binning</a></li>
  <li><a href="#シークエンス">シークエンス</a></li>
  <li><a href="#カウントデータの取り扱い">カウントデータの取り扱い</a></li>
  <li><a href="#二値化">二値化</a>
    <ul>
      <li><a href="#固定幅による離散化">固定幅による離散化</a></li>
      <li><a href="#分位数による離散化">分位数による離散化</a></li>
    </ul>
  </li>
  <li><a href="#交互作用">交互作用</a></li>
  <li><a href="#次元集約によると特徴量の作成">次元集約によると特徴量の作成</a></li>
  <li><a href="#まとめ">まとめ</a></li>
  <li><a href="#関連項目">関連項目</a></li>
  <li><a href="#参考文献">参考文献</a></li>
</ul>
    </nav>
  </aside>


      
      <main class="c-textbook__page" tabindex="-1">
          <div class="o-wrapper">
            <div class="c-sidebar-toggle">
  <!-- We show the sidebar by default so we use .is-active -->
  <button
    id="js-sidebar-toggle"
    class="hamburger hamburger--arrowalt is-active"
  >
    <span class="hamburger-box">
      <span class="hamburger-inner"></span>
    </span>
    <span class="c-sidebar-toggle__label">Toggle Sidebar</span>
  </button>
</div>

            
<div class="buttons">





</div>


            <div class="c-textbook__content">
              <div class="language-R input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">source</span><span class="p">(</span><span class="n">here</span><span class="o">::</span><span class="n">here</span><span class="p">(</span><span class="s2">"R/setup.R"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<h1 id="数値データの取り扱い">数値データの取り扱い</h1>

<p>データ分析においてもっとも一般的な型が数値データです。商品の価格やウェブページのアクセス件数、体重など多くのデータが数値で表されます。多くのモデルが数値の入力を前提としているため、数値をそのまま利用することもできます。しかし特徴量エンジニアリングが不要というわけではありません。例えば線形回帰モデルでは、出力から得られる値の誤差が正規分布に従うことを仮定します。そのため正規分布とは異なる形状の分布をもつデータ、例えば離散値ではその仮定が成立しない可能性があります。この問題を解決するために、元のデータを正規分布に近似させるという特徴量エンジニアリングが有効になります。</p>

<p>良い特徴量というのはデータの特徴を強く反映します。連続的な数値を二値化あるいは離散化することでモデルの精度が改善されることがあります。また数値以外のテキストや画像のデータを数値化した際、さらなる特徴量エンジニアリングが必要になることもあります。つまり数値データの処理は特徴量エンジニアリングの中で最も基本的な技と言えます。</p>

<p>前章で示した標準化や正規化も数値データの処理ですが、この章では数値変数をモデルに適した形式へと変換する手法を紹介します。単一の変数を対象にした処理として対数変換、離散化、ハッシュ化を扱います。また複数の特徴量から新たな特徴量を生成する手法や変数間の相互作用について導入を行います。</p>

<h2 id="数値データが抱える問題">数値データが抱える問題</h2>

<p>数値データはありふれたデータ形式ですが、その反面数多くの問題を抱えていることがあります。その特徴をあげてみます。</p>

<ul>
  <li>スケールが大きく異なる</li>
  <li>歪んだ分布をもつ</li>
  <li>大小の外れ値を含む</li>
  <li>変数間で、線形では表現できないような複雑な関係を持っている</li>
  <li>冗長な情報</li>
</ul>

<p>これらの問題は、回帰か分類かという課題設定に応じて、適用するモデルの種類によって顕在化します。一方で適切なモデルを選択することで問題のいくつかを軽減できる見込みもあります。例を見てみましょう。</p>

<p>k近傍法やサポートベクターマシンは、特徴空間上の外れ値の影響を受けやすい性質があります。一方で、実際の値ではなく順位化されたデータを利用する木ベースのモデルでは外れ値の影響を顕現することができます。また、互いに説明変数の間で強い相関がある変数を重回帰モデルに組み込むと、わずかに値が変動しただけで係数が大きく異なってしまいますが、部分最小二乗法を用いることで説明変数の相関を無相関化できます。つまり、適切なモデルとデータの変換を行うことである程度の対策が可能です。</p>

<p>説明変数(予測子) の特徴</p>

<blockquote>
  <p>The techniques in this chapter have been organizedinto three general categories . The first category of engineering techniques are those that address problematic characteristics of individual predictors (Section 6.1). Section 6.2 illustrates methods for expanding individual predictors into many predictors in order to better represent more complex predictor-response relationships and to enable the extraction of predictive information. Last, Section 6.3 provides methodology for consolidating redundant information across many predictors. In the end, the goal of all of these approaches is to convert the existing continuous predictors into a form that can be utilized by any model and presents the most useful information to the model.</p>
</blockquote>

<p>対象方法には3数類</p>

<ul>
  <li>個々の数値変数の問題について直接対処する</li>
  <li>変数変換?</li>
  <li>変数間の関係を見つめ直す</li>
</ul>

<p>これらすべてのアプローチの目的は、既存の連続予測子を任意のモデルで使用できる形式に変換し、そのモデルに最も有用な情報を提示することです。</p>

<blockquote>
  <p>As with many techniques discussed in this text, the need for these can be very data- and model-dependent. For example, transformations to resolve skewness or outliers would not be needed for some models but would be critical for others to perform well. In this chapter, a guide to which models would benefit from specific preprocessing methods will be provided.</p>
</blockquote>

<h2 id="対数変換">対数変換</h2>

<h2 id="rank-transformation">rank transformation</h2>

<h2 id="対数変換-1">対数変換</h2>

<ul>
  <li>特徴量のスケールが大きい時はその範囲を縮小し、小さい時は拡大します。これにより、裾の長い分布を正規分布の形に近づけることが期待されます。</li>
  <li>平均値が大きいグループほど分散が大きい場合には、対数変換により等分散性が確保されることが多い</li>
</ul>

<p>「下駄」を履かせることもあります。</p>

<p>ただしこの「下駄」も負値についても非負値とするために「…を足す」のような処理をすると解釈が難しくなる問題があります。ここでは解説しませんが、0や負値を含んだ特徴量を扱えるYeo-Johnson変換 (Yeo-Johnson Power Transformations) が効果的な時があります。</p>

<div class="language-R input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">log10</span><span class="p">(</span><span class="m">0</span><span class="p">)</span><span class="w">
</span><span class="n">log10</span><span class="p">(</span><span class="m">0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-R input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_lp_kanto</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">posted_land_price</span><span class="p">,</span><span class="w"> </span><span class="n">distance_from_station</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefecture</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_fill_identity</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_x_log10</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_y_log10</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<div class="language-R input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p_base</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> 
  </span><span class="n">df_lp_kanto</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">posted_land_price</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="p">,</span><span class="w"> </span><span class="n">show.legend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_fill_identity</span><span class="p">()</span><span class="w">

</span><span class="n">p</span><span class="m">1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">p_base</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">aes</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ds_col</span><span class="p">(</span><span class="m">1</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">xlab</span><span class="p">(</span><span class="s2">"円/m^2"</span><span class="p">)</span><span class="w">
</span><span class="n">p</span><span class="m">2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">p_base</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">aes</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ds_col</span><span class="p">(</span><span class="m">5</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">xlab</span><span class="p">(</span><span class="s2">"log10(円/m^2)"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_x_log10</span><span class="p">()</span><span class="w">

</span><span class="n">cowplot</span><span class="o">::</span><span class="n">plot_grid</span><span class="p">(</span><span class="w">
  </span><span class="n">p</span><span class="m">1</span><span class="p">,</span><span class="w">
  </span><span class="n">p</span><span class="m">2</span><span class="p">,</span><span class="w">
  </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h3 id="box-cox変換">Box-Cox変換</h3>

<ul>
  <li>パラメータ \lambda を変更することで、対数変換 (\lambda = 0)、平方根変換 (\lambda = 0.5)、逆数変換 (\lambda = -1.0)</li>
  <li>平方根変換 はカウントデータに適する?</li>
  <li>対数変換よりもBox-Cox変換の方が裾を縮小させることが期待される</li>
  <li>0より大きい値
    <ul>
      <li>0および負値に対応したYeo-Johnson変換については説明しない</li>
    </ul>
  </li>
</ul>

<div class="language-R input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ggplot</span><span class="p">(</span><span class="n">df_lp_kanto</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">acreage</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="p">)</span><span class="w">

</span><span class="n">rec</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> 
  </span><span class="n">recipe</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">acreage</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_lp_kanto</span><span class="p">)</span><span class="w">

</span><span class="n">rec</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">step_sqrt</span><span class="p">(</span><span class="n">all_predictors</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">prep</span><span class="p">(</span><span class="n">training</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_lp_kanto</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">juice</span><span class="p">(</span><span class="n">all_predictors</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">acreage</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="p">)</span><span class="w">

</span><span class="n">rec</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">step_log</span><span class="p">(</span><span class="n">all_predictors</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">prep</span><span class="p">(</span><span class="n">training</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_lp_kanto</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">juice</span><span class="p">(</span><span class="n">all_predictors</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">acreage</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="p">)</span><span class="w">

</span><span class="n">rec</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">step_BoxCox</span><span class="p">(</span><span class="n">all_predictors</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">prep</span><span class="p">(</span><span class="n">training</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_lp_kanto</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">juice</span><span class="p">(</span><span class="n">all_predictors</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">acreage</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="ロジット変換">ロジット変換</h2>

<ul>
  <li>百分率や比率データ
    <ul>
      <li>0から1の範囲に含まれる値を確率として表現。</li>
      <li>変換前と変換後の値を、散布図にすると曲線を描く</li>
    </ul>
  </li>
</ul>

<div class="language-R input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_lp_kanto</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">skimr</span><span class="o">::</span><span class="n">skim</span><span class="p">()</span><span class="w">
</span><span class="n">d</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> 
  </span><span class="n">df_lp_kanto</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">transmute</span><span class="p">(</span><span class="n">frontage_ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frontage_ratio</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.01</span><span class="p">)</span><span class="w">

</span><span class="n">rec</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> 
  </span><span class="n">recipe</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">frontage_ratio</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w">

</span><span class="n">df_transed</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rec</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">step_logit</span><span class="p">(</span><span class="n">all_predictors</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">prep</span><span class="p">(</span><span class="n">training</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">juice</span><span class="p">(</span><span class="n">all_predictors</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">rename</span><span class="p">(</span><span class="n">frontage_ratio_trans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frontage_ratio</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">bind_cols</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="w">

</span><span class="n">df_transed</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">frontage_ratio</span><span class="p">,</span><span class="w"> </span><span class="n">frontage_ratio_trans</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<h2 id="binning">Binning</h2>

<!-- fe-categorical? -->

<h2 id="シークエンス">シークエンス</h2>

<ul>
  <li>移動平均</li>
  <li>外れ値をもつ場合には平滑化が有効</li>
</ul>

<div class="language-R input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mod_rec</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> 
  </span><span class="n">df_lp_kanto</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">posted_land_price</span><span class="p">,</span><span class="w"> </span><span class="n">number_of_floors</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">recipe</span><span class="p">(</span><span class="n">formula</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">)</span><span class="w">

</span><span class="n">df_trans</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> 
  </span><span class="n">mod_rec</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">step_BoxCox</span><span class="p">(</span><span class="n">all_numeric</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">prep</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">juice</span><span class="p">()</span><span class="w">

</span><span class="n">p</span><span class="m">1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df_lp_kanto</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">posted_land_price</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ds_col</span><span class="p">(</span><span class="m">1</span><span class="p">))</span><span class="w">

</span><span class="n">p</span><span class="m">2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df_trans</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">posted_land_price</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ds_col</span><span class="p">(</span><span class="m">5</span><span class="p">))</span><span class="w">

</span><span class="n">plot_grid</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="m">2</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="カウントデータの取り扱い">カウントデータの取り扱い</h2>

<h2 id="二値化">二値化</h2>

<ul>
  <li>スケールによる影響を緩和するためにカウントデータを離散化</li>
</ul>

<p>地上階数はカウントデータとして与えられています。</p>

<p>カウントした値を階級にまとめる方法です。</p>

<p>階級データには順序が与えられることになります。</p>

<h3 id="固定幅による離散化">固定幅による離散化</h3>

<ul>
  <li>各階級の範囲をあらかじめ決めておく</li>
  <li>階級区分に規則性がある場合とない場合
    <ul>
      <li>年齢… 10歳区切り。階級幅は一定で規則性がある</li>
      <li>年齢… ライフスタイルによる区切り。規則性がない</li>
    </ul>
  </li>
  <li>10の累乗 (0~9, 10~99, 100~9999) 指数関数的</li>
</ul>

<h3 id="分位数による離散化">分位数による離散化</h3>

<ul>
  <li>均等に</li>
</ul>

<div class="language-R input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 5段階の階級を設定</span><span class="w">
</span><span class="n">binned</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> 
  </span><span class="n">discretize</span><span class="p">(</span><span class="n">df_lp_kanto</span><span class="o">$</span><span class="n">distance_from_station</span><span class="p">,</span><span class="w"> 
             </span><span class="n">cuts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> 
             </span><span class="n">infs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> 
             </span><span class="n">keep_na</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
             </span><span class="n">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"distance_bins"</span><span class="p">)</span><span class="w">
</span><span class="n">table</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="n">binned</span><span class="p">,</span><span class="w"> </span><span class="n">df_lp_kanto</span><span class="o">$</span><span class="n">distance_from_station</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="language-R input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># box-cox変換 ---------------------------------------------------------------</span><span class="w">
</span><span class="c1"># モデルを定義... 線形回帰モデル</span><span class="w">
</span><span class="n">spec_lin_reg</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">linear_reg</span><span class="p">()</span><span class="w">
</span><span class="c1"># エンジンを指定... stats::lm</span><span class="w">
</span><span class="n">spec_lm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">set_engine</span><span class="p">(</span><span class="n">spec_lin_reg</span><span class="p">,</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"lm"</span><span class="p">)</span><span class="w">


</span><span class="c1"># 同じ結果... formulaで参照するのではなく、x,yにデータを与える</span><span class="w">
</span><span class="n">fit_xy</span><span class="p">(</span><span class="n">spec_lm</span><span class="p">,</span><span class="w"> 
       </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_train_baked</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">pull</span><span class="p">(</span><span class="n">posted_land_price</span><span class="p">),</span><span class="w">
       </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_train_baked</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
         </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">posted_land_price</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">tidy</span><span class="p">()</span><span class="w">

</span><span class="n">df_train_price_log</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">
  </span><span class="n">df_train</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log10</span><span class="p">(</span><span class="n">posted_land_price</span><span class="p">),</span><span class="w">
         </span><span class="n">distance_from_station</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log10</span><span class="p">(</span><span class="n">distance_from_station</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w">

</span><span class="c1"># df_train %&gt;% </span><span class="w">
</span><span class="c1">#   recipe(mod_formula) %&gt;% </span><span class="w">
</span><span class="c1">#   step_BoxCox(all_outcomes(), lambdas = 1.0) %&gt;% </span><span class="w">
</span><span class="c1">#   step_log(distance_from_station, base = 10) %&gt;% </span><span class="w">
</span><span class="c1">#   prep(training = df_train) %&gt;% </span><span class="w">
</span><span class="c1">#   juice()</span><span class="w">

</span><span class="c1"># stanエンジン (rstan::stan())</span><span class="w">
</span><span class="n">spec_stan</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> 
  </span><span class="n">spec_lin_reg</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">set_engine</span><span class="p">(</span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"stan"</span><span class="p">,</span><span class="w"> </span><span class="n">chains</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span><span class="p">)</span><span class="w">

</span><span class="n">fit_stan</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fit</span><span class="p">(</span><span class="w">
  </span><span class="n">spec_stan</span><span class="p">,</span><span class="w">
  </span><span class="n">mod_formula2</span><span class="p">,</span><span class="w">
  </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_train</span><span class="p">)</span><span class="w">

</span><span class="n">coef</span><span class="p">(</span><span class="n">fit_stan</span><span class="o">$</span><span class="n">fit</span><span class="p">)</span><span class="w">
</span><span class="n">fit_stan</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">broom</span><span class="o">::</span><span class="n">tidy</span><span class="p">()</span><span class="w">

</span><span class="c1"># knn</span><span class="w">
</span><span class="n">fit_knn</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">
  </span><span class="n">nearest_neighbor</span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"regression"</span><span class="p">,</span><span class="w"> </span><span class="n">neighbors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">set_engine</span><span class="p">(</span><span class="s2">"kknn"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">fit</span><span class="p">(</span><span class="n">mod_formula2</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_train</span><span class="p">)</span><span class="w">

</span><span class="n">predict</span><span class="p">(</span><span class="n">fit_knn</span><span class="p">,</span><span class="w"> </span><span class="n">new_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_test</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
          </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">posted_land_price</span><span class="p">))</span><span class="w">

</span><span class="n">car</span><span class="o">::</span><span class="n">powerTransform</span><span class="p">(</span><span class="n">df_lp_kanto</span><span class="o">$</span><span class="n">posted_land_price</span><span class="p">)</span><span class="w">

</span><span class="n">library</span><span class="p">(</span><span class="n">car</span><span class="p">)</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">powerTransform</span><span class="p">(</span><span class="n">cycles</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">amp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">load</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Wool</span><span class="p">))</span><span class="w">
</span><span class="c1"># fit linear model with transformed response:</span><span class="w">
</span><span class="n">coef</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">round</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">m</span><span class="m">1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lm</span><span class="p">(</span><span class="n">bcPower</span><span class="p">(</span><span class="n">cycles</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="m">1</span><span class="o">$</span><span class="n">roundlam</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">amp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">load</span><span class="p">,</span><span class="w"> </span><span class="n">Wool</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="language-R input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_lp_kanto</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">count</span><span class="p">(</span><span class="n">current_use</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">forcats</span><span class="o">::</span><span class="n">fct_reorder</span><span class="p">(</span><span class="n">current_use</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"identity"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">coord_flip</span><span class="p">()</span><span class="w">
</span><span class="n">df_lp_kanto</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">count</span><span class="p">(</span><span class="n">use_district</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">forcats</span><span class="o">::</span><span class="n">fct_reorder</span><span class="p">(</span><span class="n">use_district</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"identity"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">coord_flip</span><span class="p">()</span><span class="w">

</span><span class="n">recipe</span><span class="p">(</span><span class="n">formula</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod_formula3</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_train</span><span class="p">)</span><span class="w">

</span><span class="n">mod_rec</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> 
  </span><span class="n">recipe</span><span class="p">(</span><span class="n">formula</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod_formula3</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_train</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">step_log</span><span class="p">(</span><span class="n">all_outcomes</span><span class="p">(),</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="c1"># 5%未満を "other"</span><span class="w">
  </span><span class="n">step_other</span><span class="p">(</span><span class="n">use_district</span><span class="p">,</span><span class="w"> </span><span class="n">threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">step_dummy</span><span class="p">(</span><span class="n">all_nominal</span><span class="p">())</span><span class="w">

</span><span class="n">mod_rec</span><span class="w">

</span><span class="c1"># recipe (define) -&gt; prep (calculate) -&gt; bake/juice (apply)</span><span class="w">
</span><span class="n">mod_rec_trained</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">prep</span><span class="p">(</span><span class="n">mod_rec</span><span class="p">,</span><span class="w"> </span><span class="n">training</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_train</span><span class="p">,</span><span class="w"> </span><span class="n">verbose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="n">lp_test_dummy</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">bake</span><span class="p">(</span><span class="n">mod_rec_trained</span><span class="p">,</span><span class="w"> </span><span class="n">new_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_test</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">lp_test_dummy</span><span class="p">)</span><span class="w"> </span><span class="c1"># 1住居がない（一番多い）</span><span class="w">
</span></code></pre></div></div>

<div class="language-R input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># interaction</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span><span class="w">
       </span><span class="n">aes</span><span class="p">(</span><span class="n">distance_from_station</span><span class="p">,</span><span class="w"> </span><span class="n">posted_land_price</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_y_log10</span><span class="p">()</span><span class="w">

</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_smooth</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"loess"</span><span class="p">)</span><span class="w">

</span><span class="c1"># MASS::rlm()</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">MASS</span><span class="p">)</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">gas_facility</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_smooth</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"rlm"</span><span class="p">)</span><span class="w">

</span><span class="n">mod1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lm</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">posted_land_price</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">distance_from_station</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_train</span><span class="p">)</span><span class="w">
</span><span class="n">mod2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lm</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">posted_land_price</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">distance_from_station</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gas_facility</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">distance_from_station</span><span class="o">:</span><span class="n">gas_facility</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_train</span><span class="p">)</span><span class="w">

</span><span class="n">anova</span><span class="p">(</span><span class="n">mod1</span><span class="p">,</span><span class="w"> </span><span class="n">mod2</span><span class="p">)</span><span class="w">

</span><span class="n">mod_formula4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">formula</span><span class="p">(</span><span class="n">posted_land_price</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">distance_from_station</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gas_facility</span><span class="p">)</span><span class="w">
</span><span class="n">df_train</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">recipe</span><span class="p">(</span><span class="n">mod_formula4</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">step_log</span><span class="p">(</span><span class="n">all_outcomes</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">step_dummy</span><span class="p">(</span><span class="n">gas_facility</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">step_interact</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">starts_with</span><span class="p">(</span><span class="s2">"gas_facility"</span><span class="p">)</span><span class="o">:</span><span class="n">distance_from_station</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">prep</span><span class="p">(</span><span class="n">training</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_train</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">juice</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<h2 id="交互作用">交互作用</h2>

<h2 id="次元集約によると特徴量の作成">次元集約によると特徴量の作成</h2>

<ul>
  <li>PCA, ICA</li>
  <li>L2ノルム正則化… ベクトル空間に対して「距離」を与えるための数学の道具</li>
</ul>

<p>過学習を防ぐためでもある</p>

<!-- reduction... ここでは概要説明のみ。詳しくは該当する章で-->

<h2 id="まとめ">まとめ</h2>

<blockquote>
  <p>対数をとるモデルと対数をとらないモデルのどちらか一方が「正しい」わけではない。あくまでも「そういう仮定を選んだ」ということに過ぎない</p>
</blockquote>

<p>数値特徴量</p>

<p>特徴量の管理、膨大に増えた特徴量の次元削減については別の章で解説します。</p>

<h2 id="関連項目">関連項目</h2>

<ul>
  <li><a href="feature-selection">特徴量選択</a></li>
</ul>

<h2 id="参考文献">参考文献</h2>

<ul>
  <li>Max Kuhn and Kjell Johnson (2013). Applied Predictive Modeling. (Springer)</li>
</ul>

              <nav class="c-page__nav">
  
    
    <a id="js-page__nav__prev" class="c-page__nav__prev" href="/practical-ds/02/readme">
      〈 <span class="u-margin-right-tiny"></span> 特徴量エンジニアリング
    </a>
  

  
    
    <a id="js-page__nav__next" class="c-page__nav__next" href="/practical-ds/02/categorical">
      カテゴリデータの取り扱い <span class="u-margin-right-tiny"></span> 〉
    </a>
  
</nav>

            </div>
          </div>
        </div>
      </main>
    </div>

  </body>
</html>
